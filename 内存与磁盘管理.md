# 内存与磁盘管理

## free查看内存的使用情况

- 实例

  ```shell
  #以m为单位显示内存
  free -m
  #方便阅读地显示内存
  free -h
  #周期性查看内存使用信息
  free -s 10
  ```

- TLDR

  ```shell
    free
  
    Display amount of free and used memory in the system.
    More information: https://manned.org/free.
  
    - Display system memory:
      free
  
    - Display memory in Bytes/KB/MB/GB:
      free -b|k|m|g
  
    - Display memory in human-readable units:
      free -h
  
    - Refresh the output every 2 seconds:
      free -s 2
  ```

  

## fdisk 查看磁盘使用情况

- 实例

  ```shell
  #查看磁盘分区
  fdisk -l
  #磁盘分区位置
  /dev/sda
  /dev/vda
  ```

- TLDR

  ```shell
    fdisk
  
    A program for managing partition tables and partitions on a hard disk.
    See also: `partprobe`.
    More information: https://manned.org/fdisk.
  
    - List partitions:
      sudo fdisk -l
  
    - Start the partition manipulator:
      sudo fdisk /dev/sdX
  
    - Once partitioning a disk, create a partition:
      n
  
    - Once partitioning a disk, select a partition to delete:
      d
  
    - Once partitioning a disk, view the partition table:
      p
  
    - Once partitioning a disk, write the changes made:
      w
  
    - Once partitioning a disk, discard the changes made:
      q
  
    - Once partitioning a disk, open a help menu:
      m
  ```



## df 查看磁盘空闲情况

- 实例

  ```shell
  #以高可读性显示磁盘使用情况
  df -h
  #以m为单位显示磁盘使用情况
  df -m
  #查看全部系统文件
  df -a
  #查看指定文件或目录的空间使用情况
  df /root
  df /root/ping.txt
  ```

- TLDR

  ```shell
    df
  
    Gives an overview of the filesystem disk space usage.
    More information: https://www.gnu.org/software/coreutils/df.
  
    - Display all filesystems and their disk usage:
      df
  
    - Display all filesystems and their disk usage in human-readable form:
      df -h
  
    - Display the filesystem and its disk usage containing the given file or directory:
      df path/to/file_or_directory
  
    - Display statistics on the number of free inodes:
      df -i
  
    - Display filesystems but exclude the specified types:
      df -x squashfs -x tmpfs
  ```



## du 查看指定文件磁盘使用

- 实例

  ```shell
  #查看指定文件或目录的空间占用情况
  du -m /root/Desktop
  #以高可读性查看指定文件或目录的空间占用情况
  du -h /root/Desktop
  #仅统计文件夹的空间占用情况,高可读性
  du -sh /root
  #当前所在目录，按文件大小排序
  du -sh * | sort -h
  #查看指定文件占用的空间
  du -h /root/ping.txt
  ```

- du和ls的区别

  ```shell
  #dd命令可以用于测试内存的读写速度
  #生成一个块大小为4M，总计10块的文件，输入文件为/dev/zero,输出文件为afile
  dd if=/dev/zero bs=4M count=10 of=afile
  #生成一个块大小为4M，总计10块，头部跳过20块的文件，输入文件为/dev/zero,输出文件为bfile
  dd if=/dev/zero bs=4M count=10 seek=20 of=bfile
  ls -lh
  du -h
  #du查看的是文件的实际大小，不包括虚拟的占用空间
  #ls查看的是文件的逻辑大小，包括了虚拟的占用空间
  ```

- TLDR

  ```shell
    du
  
    Disk usage: estimate and summarize file and directory space usage.
    More information: https://www.gnu.org/software/coreutils/du.
  
    - List the sizes of a directory and any subdirectories, in the given unit (B/KiB/MiB):
      du -b|k|m path/to/directory
  
    - List the sizes of a directory and any subdirectories, in human-readable form (i.e. auto-selecting the appropriate unit for each size):
      du -h path/to/directory
  
    - Show the size of a single directory, in human-readable units:
      du -sh path/to/directory
  
    - List the human-readable sizes of a directory and of all the files and directories within it:
      du -ah path/to/directory
  
    - List the human-readable sizes of a directory and any subdirectories, up to N levels deep:
      du -h --max-depth=N path/to/directory
  
    - List the human-readable size of all `.jpg` files in subdirectories of the current directory, and show a cumulative total at the end:
      du -ch */*.jpg
  ```



## 系统文件格式

- 目前使用的格式说明

  ```shell
  ext4  早期版本
  xfs   现在主流
  NTFS  额外支持
  ```

- ext4文件格式说明

  ```shell
  ext4 ⽂件系统基本结构⽐较复杂
      超级块              记录整个文件系统包含的文件总数
      超级块副本          对超级块的备份
      i 节点(inode)       记录每一个文件的名称、文件大小、文件编号、文件权限
      数据块(datablock)   记录数据
  ```



## facl 设置文件访问控制列表

- 实例

  ```shell
  getfacl file    查看文件的访问权限信息
  setfacl -m u:user1:r file 指定某个用户对文件的某个权限
  setfacl -m u:user2:rw file
  setfacl -m g:group1:rw file
  setfacl -g u:user1:r file 收回某个用户对文件的某个权限
  ```

- TLDR

  ```shell
  
  ```

  

## fdisk 磁盘分区

- 实例

  ```shell
  #在虚拟机管理界面添加硬盘后，需要重启linux
  #查看所有磁盘状态
  fdisl -l
  #使用fdisk对新添加的磁盘设备进行分区
  fdisk /dev/sdb
  #m 列出可执行的命令
  #n 新建分区
  #p 主分区，只能建立四个
  #e 扩展分区
  #d 删除分区
  #p 查看当前分区状态
  #w 写入分区信息
  ```

- TLDR

  ```shell
    fdisk
  
    A program for managing partition tables and partitions on a hard disk.
    See also: `partprobe`.
    More information: https://manned.org/fdisk.
  
    - List partitions:
      sudo fdisk -l
  
    - Start the partition manipulator:
      sudo fdisk /dev/sdX
  
    - Once partitioning a disk, create a partition:
      n
  
    - Once partitioning a disk, select a partition to delete:
      d
  
    - Once partitioning a disk, view the partition table:
      p
  
    - Once partitioning a disk, write the changes made:
      w
  
    - Once partitioning a disk, discard the changes made:
      q
  
    - Once partitioning a disk, open a help menu:
      m
  ```



## mkfs 磁盘格式化

- 实例

  ```shell
  #mkfs不能对2T以上的磁盘进行格式化
  #可选分区格式：mkfs.ext4/mkfs.xfs
  #以ext4格式格式化/dev/sdb1
  mkfs.ext4 /dev/sdb1
  #t:挂载
  mount -t ect4 /dev/sdb1 /mnt/sdb1
  mount -t auto /dev/sdb1 /mnt/sdb1
  mount /dev/sdb1 /mnt/sdb1
  ```

- TLDR

  ```SHELL
    mkfs
  
    Build a Linux filesystem on a hard disk partition.
    This command is deprecated in favor of filesystem specific mkfs. utils.
    More information: https://manned.org/mkfs.
  
    - Build a Linux ext2 filesystem on a partition:
      mkfs path/to/partition
  
    - Build a filesystem of a specified type:
      mkfs -t ext4 path/to/partition
  
    - Build a filesystem of a specified type and check for bad blocks:
      mkfs -c -t ntfs path/to/partition
  ```



## parted 磁盘格式化

- 实例

- TLDR

  ```shell
    parted
  
    A partition manipulation program.
    See also: partprobe.
    More information: https://www.gnu.org/software/parted/parted.html.
  
    - List partitions on all block devices:
      sudo parted --list
  
    - Start interactive mode with the specified disk selected:
      sudo parted /dev/sdX
  
    - Create a new partition table of the specified label-type:
      sudo parted --script /dev/sdX mklabel aix|amiga|bsd|dvh|gpt|loop|mac|msdos|pc98|sun
  
    - Show partition information in interactive mode:
      print
  
    - Select a disk in interactive mode:
      select /dev/sdX
  
    - Create a 16 GB partition with the specified filesystem in interactive mode:
      mkpart primary|logical|extended btrfs|ext2|ext3|ext4|fat16|fat32|hfs|hfs+|linux-swap|ntfs|reiserfs|udf|xfs 0% 16G
  
    - Resize a partition in interactive mode:
      resizepart /dev/sdXN end_position_of_partition
  
    - Remove a partition in interactive mode:
      rm /dev/sdXN
  ```



## mount 磁盘挂载

- 实例

  ```shell
  #ext4：挂载的磁盘格式
  #defaults：挂载的操作权限
  #0 0：是否备份，开机是否自检
  /dev/sdb1 /mnt/sdb1 ext4 defaults 0 0
  #永久写入配置
  /etc/fstab
  #ext4：挂载的磁盘格式
  #defaults：挂载的操作权限
  #0 0：是否备份，开机是否自检
  /dev/sdb1 /mnt/sdb1 ext4 defaults 0 0
  ```

- TLDR

  ```shell
    mount
  
    Provides access to an entire filesystem in one directory.
    More information: https://manned.org/mount.8.
  
    - Show all mounted filesystems:
      mount
  
    - Mount a device to a directory:
      mount -t filesystem_type path/to/device_file path/to/target_directory
  
    - Mount a CD-ROM device (with the filetype ISO9660) to /cdrom (readonly):
      mount -t iso9660 -o ro /dev/cdrom /cdrom
  
    - Mount all the filesystem defined in /etc/fstab:
      mount -a
  
    - Mount a specific filesystem described in /etc/fstab (e.g. /dev/sda1 /my_drive ext2 defaults 0 2):
      mount /my_drive
  
    - Mount a directory to another directory:
      mount --bind path/to/old_dir path/to/new_dir
  ```



## 磁盘配额

### xfs ⽂件系统的磁盘配额

- 实例

  ```shell
  quota
  mkfs.xfs /dev/sdb1
  #磁盘如果有信息，需要-f强制格式化
  mkfs.xfs -f /dev/sdb1
  mkdir /mnt/disk1
  #-p：如果有这个文件夹，则不做操作
  mkdir -p /mnt/disk1
  #-o：需要支持磁盘配额
  #uquota：支持用户磁盘配额
  #gquota：支持组磁盘配额
  mount -o uquota,gquota /dev/sdb1 /mnt/disk1
  chmod 1777 /mnt/disk1
  #u:user
  #g:group
  #i:inodes
  #b:block
  #h:humanity
  xfs_quota -x -c 'report -ugibh' /mnt/disk1 
  #-u：限制用户磁盘配额
  #-g：限制组磁盘配额
  #isoft：inodes软限制
  #ihard：inodes硬限制
  #软限制不允许超过硬限制
  #限制user1用户
  xfs_quota -x -c 'limit -u isoft=5 ihard=10 user1' /mnt/disk1
  ```



### edquota 编辑磁盘配额

- 实例

  ```shell
  
  ```

- TLDR

  ```shell
  
  ```

  

## mkswap 虚拟内存

- 使用磁盘分区作为虚拟内存

  ```shell
  #指定虚拟内存设备
  mkswap /dev/sdd1
  #开关虚拟内存
  swapon /dev/sdd1
  swapoff /dev/sdd1
  ```

- 使用文件作为虚拟内存

  ```shell
  dd if=/dev/zero bs=4M count=1024 
  #写入文件
  /etc/fstab
  #如果是专用的分区
  #挂载位置，挂载类型，挂载格式，挂
  /dev/sdd1 swap swap defaults 0 0
  #如果是文件
  /swapfile swap swap defaults 0 0
  ```

  

## RAID技术

- RAID 的常⻅级别及含义

  >RAID 0 striping 条带⽅式，提⾼单盘吞吐率
  >RAID 1 mirroring 镜像⽅式，提⾼可靠性
  >RAID 5 有奇偶校验
  >RAID 10 是RAID 1 与 RAID 0 的结合

- 软RAID

  ```shell
  #创建软件RAID
  mdadm -C /dev/md0 -a yes -l1 -n2 /dev/sdb1 /dev/sdb2 /dev/sdb3
  mdadm -C /dev/md0 -a yes -l1 -n2 /dev/sdb[1,2,3]
  #查看使用状态
  mdadm -D /dev/md0
  #写入配置文件
  echo DEVICE /dev/sdb[1,2,3] >> /etc/madam.conf
  mdadm -Evs >> /etc/mdadm.conf
  #格式化分区
  mkfs.xfs /dev/md0
  #挂载到指定目录
  mkdir /mnt/md0
  mount /dev/md0 /mnt/md0
  #关闭软件RAID
  mdadm --stop /dev/md0
  #破坏超级块
  dd if=/dev/zero of=/dev/sdb1 bs=1M count=1
  dd if=/dev/zero of=/dev/sdb2 bs=1M count=1
  dd if=/dev/zero of=/dev/sdb3 bs=1M count=1
  ```

  

## 逻辑卷管理

- 实例

  ```shell
  #格式化之后创建物理卷
  pvcreate /dev/sd[b,c,d]1
  #查看物理卷
  pvs
  #建立卷组
  vgcreate vg1 /dev/sdb1 /dev/sdc1
  #查看卷组
  vgs
  #创建逻辑卷
  lvcreate -L 100M -n lv1 vg1
  #查看逻辑卷
  lvs
  #格式化和挂载
  mkdir /mnt/lvs1
  mkfs.xfs /dev/vg1/lv1
  mount /dev/vg1/lv1 /mnt/lvs1
  vgextend centos /dev/sdd1
  pvs
  vgs
  lvs
  lvextend -L +50G /dev/centos/root
  lvs
  df -h
  xfs_growfs /dev/centos/root
  df -h
  ```



## sar 系统状态查看

- 实例

  ```shell
  #查看CPU装填
  sar -u 1 10
  #查看内存状态
  sar -r 1 10
  #查看磁盘状态
  sar -b 1 10
  #查看每一块磁盘的读写
  sar -d 1 10
  #查看进程的状态
  sar -q 1 10
  
  #网络流量查看
  iftop
  ```

- TLDR

  ```shell
    sar
  
    Monitor performance of various Linux subsystems.
    More information: https://manned.org/sar.
  
    - Report I/O and transfer rate issued to physical devices, one per second (press CTRL+C to quit):
      sar -b 1
  
    - Report a total of 10 network device statistics, one per 2 seconds:
      sar -n DEV 2 10
  
    - Report CPU utilization, one per 2 seconds:
      sar -u ALL 2
  
    - Report a total of 20 memory utilization statistics, one per second:
      sar -r ALL 1 20
  
    - Report the run queue length and load averages, one per second:
      sar -q 1
  
    - Report paging statistics, one per 5 seconds:
      sar -B 5
  ```

  